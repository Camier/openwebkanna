# OCSR Backend Configuration
# Last updated: 2026-02-25
# Version: 1.0.0

# Primary backend: MolScribe (MIT license, 93% F1 accuracy)
molscribe:
  enabled: true
  priority: 1
  version: 1.1.1
  license: MIT

  # Model configuration
  model: swin_base_char_aux_1m.pth
  model_cache: ~/.cache/molscribe

  # Device configuration
  device: cuda
  device_fallback: cpu
  gpu_memory_threshold: 0.8  # Use fallback if GPU memory >80%

  # Inference settings
  batch_size: 32
  max_image_size: 2048  # Resize larger images
  confidence_threshold: 0.5  # Minimum confidence to accept

  # Performance
  inference_timeout: 30  # seconds per image
  retry_on_failure: true
  max_retries: 2

  # Accuracy benchmarks (from Krasnov et al. 2024)
  benchmarks:
    single_molecule_f1: 0.93
    stereochemistry_preservation: 0.85-0.90
    multi_structure_f1: 0.68
    average_inference_time_ms: 150-300

# Fallback backend: DECIMER 2.2 (CC BY 4.0, 91% F1 accuracy)
decimer:
  enabled: true
  priority: 2
  version: 2.2
  license: CC-BY-4.0  # Requires attribution in outputs

  # Model configuration
  model: vit_base
  model_cache: ~/.cache/decimer

  # Device configuration
  device: cuda
  device_fallback: cpu

  # Inference settings
  batch_size: 16  # Smaller than MolScribe due to VRAM requirements
  max_image_size: 1536
  confidence_threshold: 0.5

  # Performance
  inference_timeout: 60  # DECIMER is slower
  retry_on_failure: true
  max_retries: 2

  # Components
  segmentation:
    enabled: true  # Mask R-CNN for image segmentation
    model: DECIMER_Segmentation.h5

  classifier:
    enabled: true  # Chemical vs non-chemical classification
    model: DECIMER_Classifier.h5

  # Accuracy benchmarks
  benchmarks:
    single_molecule_f1: 0.91
    stereochemistry_preservation: 0.80-0.85
    multi_structure_f1: 0.72
    average_inference_time_ms: 200-500

  # Attribution requirement
  attribution: "DECIMER 2.2 by Kohulan Rajan et al. (Nature Communications 2023)"

# CPU-only fallback: MolVec (Apache 2.0, 72% F1 accuracy)
molvec:
  enabled: true
  priority: 3
  version: 0.9.7
  license: Apache-2.0

  # Device (CPU only)
  device: cpu

  # Inference settings
  max_image_size: 1024

  # Performance
  inference_timeout: 10  # Very fast
  retry_on_failure: false

  # Use cases
  use_when:
    - gpu_unavailable: true
    - multi_structure_images: true  # Best among all tools for this
    - batch_processing: true  # Fast CPU processing

  # Accuracy benchmarks
  benchmarks:
    single_molecule_f1: 0.72
    multi_structure_f1: 0.66
    average_inference_time_ms: 50

# Routing strategy
routing:
  # Default strategy: try backends in priority order
  strategy: priority_fallback

  # Image type routing overrides
  by_image_type:
    single_molecule:
      backends: [molscribe, decimer, molvec]
      confidence_boost: 0.1  # Boost confidence for ideal images

    reaction:
      backends: [decimer, molscribe, molvec]  # DECIMER better for reactions
      confidence_boost: 0.0

    multi_structure:
      backends: [molvec, decimer, molscribe]  # MolVec best for this
      segment_first: true  # Segment before OCSR

    non_chemical:
      backends: []  # Skip OCSR entirely
      action: skip_with_log

# Fallback behavior
fallback:
  # If all backends fail
  on_all_failed:
    action: log_and_skip
    include_in_report: true
    mark_for_manual_review: true

  # Minimum confidence to accept any result
  min_confidence: 0.4

  # When confidence is low (0.4-0.6), flag for review
  low_confidence_review:
    enabled: true
    threshold: 0.6

# Performance monitoring
monitoring:
  enabled: true
  log_per_image: false  # Too verbose, enable only for debugging
  aggregate_stats: true
  report_interval: 100  # Log stats every N images

  metrics:
    - inference_time_per_backend
    - success_rate_per_backend
    - confidence_distribution
    - gpu_memory_usage
    - fallback_rate
