# Weekly Security Audit Workflow
# Scans Docker images for vulnerabilities using Trivy
# Creates GitHub issues for HIGH/CRITICAL findings

name: Security Audit

on:
  schedule:
    # Monday at 6:00 AM UTC
    - cron: '0 6 * * 1'
  workflow_dispatch:

env:
  # Images to scan (from docker-compose.yml)
  IMAGES: >-
    pgvector/pgvector:pg16
    eceasy/cli-proxy-api:v6.8.18
    ghcr.io/open-webui/open-webui:v0.8.3
    jupyter/scipy-notebook:latest

jobs:
  check-versions:
    name: Check Docker Image Versions
    runs-on: ubuntu-latest
    outputs:
      images: ${{ steps.extract.outputs.images }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract image versions from docker-compose.yml
        id: extract
        run: |
          echo "=== Docker Image Versions ===" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Extract images from docker-compose.yml
          images=$(grep -E '^\s+image:' docker-compose.yml | sed 's/.*image:\s*//' | sort -u)

          echo "Extracted images:"
          echo "$images"

          echo "$images" | while read -r img; do
            if [ -n "$img" ]; then
              echo "- \`$img\`" >> $GITHUB_STEP_SUMMARY
            fi
          done

          # Store as JSON array for downstream jobs
          images_json=$(echo "$images" | jq -R -s 'split("\n") | map(select(length > 0))')
          echo "images=$images_json" >> $GITHUB_OUTPUT

      - name: Check for outdated base images
        run: |
          echo "=== Image Freshness Check ===" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check OpenWebUI for newer versions
          latest_openwebui=$(curl -s "https://api.github.com/repos/open-webui/open-webui/releases/latest" | jq -r '.tag_name' 2>/dev/null || echo "unknown")
          current_openwebui="v0.8.3"

          if [ "$latest_openwebui" != "unknown" ] && [ "$latest_openwebui" != "$current_openwebui" ]; then
            echo "- OpenWebUI: Current \`$current_openwebui\`, Latest \`$latest_openwebui\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "- OpenWebUI: Up to date (\`$current_openwebui\`)" >> $GITHUB_STEP_SUMMARY
          fi

  trivy-scan:
    name: Trivy Vulnerability Scan
    runs-on: ubuntu-latest
    needs: check-versions
    strategy:
      fail-fast: false
      matrix:
        image:
          - pgvector/pgvector:pg16
          - eceasy/cli-proxy-api:v6.8.18
          - ghcr.io/open-webui/open-webui:v0.8.3
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ matrix.image }}
          format: 'sarif'
          output: 'trivy-${{ strategy.job-index }}.sarif'
          severity: 'HIGH,CRITICAL'
          exit-code: '0'  # Don't fail; we'll create issues instead
          ignore-unfixed: true

      - name: Run Trivy for JSON output
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ matrix.image }}
          format: 'json'
          output: 'trivy-${{ strategy.job-index }}.json'
          severity: 'HIGH,CRITICAL'
          exit-code: '0'
          ignore-unfixed: true

      - name: Upload SARIF result
        uses: actions/upload-artifact@v4
        with:
          name: trivy-sarif-${{ strategy.job-index }}
          path: trivy-${{ strategy.job-index }}.sarif
          retention-days: 30

      - name: Upload JSON result
        uses: actions/upload-artifact@v4
        with:
          name: trivy-json-${{ strategy.job-index }}
          path: trivy-${{ strategy.job-index }}.json
          retention-days: 30

      - name: Summarize vulnerabilities
        id: summarize
        run: |
          image_name="${{ matrix.image }}"
          json_file="trivy-${{ strategy.job-index }}.json"

          if [ -f "$json_file" ]; then
            critical=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "CRITICAL")] | length' "$json_file" 2>/dev/null || echo "0")
            high=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "HIGH")] | length' "$json_file" 2>/dev/null || echo "0")

            echo "### Image: \`${image_name}\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- CRITICAL: ${critical}" >> $GITHUB_STEP_SUMMARY
            echo "- HIGH: ${high}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            echo "critical=${critical}" >> $GITHUB_OUTPUT
            echo "high=${high}" >> $GITHUB_OUTPUT
            echo "has_vulns=$((critical + high > 0))" >> $GITHUB_OUTPUT
          else
            echo "critical=0" >> $GITHUB_OUTPUT
            echo "high=0" >> $GITHUB_OUTPUT
            echo "has_vulns=false" >> $GITHUB_OUTPUT
          fi

    outputs:
      critical: ${{ steps.summarize.outputs.critical }}
      high: ${{ steps.summarize.outputs.high }}
      has_vulns: ${{ steps.summarize.outputs.has_vulns }}

  trivy-fs-scan:
    name: Trivy Filesystem Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Trivy filesystem scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-fs.sarif'
          severity: 'HIGH,CRITICAL'
          exit-code: '0'
          ignore-unfixed: true

      - name: Upload filesystem SARIF
        uses: actions/upload-artifact@v4
        with:
          name: trivy-fs-sarif
          path: trivy-fs.sarif
          retention-days: 30

  trivy-config-scan:
    name: Trivy Config Scan (docker-compose)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Trivy config scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: 'docker-compose.yml'
          format: 'sarif'
          output: 'trivy-config.sarif'
          severity: 'HIGH,CRITICAL'
          exit-code: '0'

      - name: Upload config SARIF
        uses: actions/upload-artifact@v4
        with:
          name: trivy-config-sarif
          path: trivy-config.sarif
          retention-days: 30

  upload-sarif:
    name: Upload SARIF to GitHub Security
    runs-on: ubuntu-latest
    needs: [trivy-scan, trivy-fs-scan, trivy-config-scan]
    permissions:
      security-events: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: sarif-results

      - name: Merge SARIF files
        run: |
          mkdir -p merged-sarif
          find sarif-results -name "*.sarif" -exec cp {} merged-sarif/ \;
          echo "Merged $(ls merged-sarif/*.sarif 2>/dev/null | wc -l) SARIF files"

      - name: Upload SARIF to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: merged-sarif
          category: trivy-security-audit
        continue-on-error: true

  create-issue:
    name: Create Issue if Vulnerabilities Found
    runs-on: ubuntu-latest
    needs: [trivy-scan]
    if: always()
    permissions:
      issues: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all JSON artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: trivy-json-*
          path: trivy-results
          merge-multiple: true

      - name: Check for vulnerabilities and create issue
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Aggregate vulnerability counts
          total_critical=0
          total_high=0
          vuln_details=""

          for json_file in trivy-results/*.json; do
            if [ -f "$json_file" ]; then
              critical=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "CRITICAL")] | length' "$json_file" 2>/dev/null || echo "0")
              high=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "HIGH")] | length' "$json_file" 2>/dev/null || echo "0")

              total_critical=$((total_critical + critical))
              total_high=$((total_high + high))

              # Extract image name from results if available
              image_name=$(jq -r '.ArtifactName // "unknown"' "$json_file" 2>/dev/null)
              if [ "$critical" -gt 0 ] || [ "$high" -gt 0 ]; then
                vuln_details="${vuln_details}"$'\n'"- **${image_name}**: ${critical} CRITICAL, ${high} HIGH"
              fi
            fi
          done

          echo "Total CRITICAL: ${total_critical}"
          echo "Total HIGH: ${total_high}"

          if [ "$total_critical" -gt 0 ] || [ "$total_high" -gt 0 ]; then
            # Check if an open issue already exists
            existing_issue=$(gh issue list \
              --label "security,vulnerability,automated" \
              --state open \
              --json number \
              --jq '.[0].number // empty' 2>/dev/null || echo "")

            issue_title="[Security Audit] ${total_critical} CRITICAL, ${total_high} HIGH vulnerabilities found"
            issue_date=$(date -u '+%Y-%m-%d')
            repo="${GITHUB_REPOSITORY}"
            run_id="${GITHUB_RUN_ID}"
            event="${GITHUB_EVENT_NAME}"

            # Build issue body using heredoc to avoid YAML parsing issues
            issue_body=$(cat <<EOF
          ## Security Vulnerability Report

          Scan Date: ${issue_date}
          Triggered by: ${event}

          ### Summary

          | Severity | Count |
          |----------|-------|
          | CRITICAL | ${total_critical} |
          | HIGH | ${total_high} |

          ### Affected Images

          ${vuln_details}

          ### Actions Required

          1. Review the full Trivy scan results in the Security tab
          2. Update affected images to newer versions where available
          3. Apply patches or mitigations for critical vulnerabilities
          4. Re-run the security scan after fixes

          ### References

          - Workflow run: https://github.com/${repo}/actions/runs/${run_id}
          - Trivy documentation: https://aquasecurity.github.io/trivy/

          ---
          This issue was automatically created by the security-audit workflow.
          EOF
          )

            if [ -n "$existing_issue" ]; then
              echo "Updating existing issue #${existing_issue}"
              update_body="## Update: ${issue_date}"$'\n\n'"${issue_body}"
              gh issue comment "$existing_issue" --body "$update_body"
            else
              echo "Creating new issue"
              gh issue create \
                --title "$issue_title" \
                --body "$issue_body" \
                --label "security,vulnerability,automated"
            fi
          else
            echo "No HIGH or CRITICAL vulnerabilities found. No issue created."
            echo "### No vulnerabilities found" >> $GITHUB_STEP_SUMMARY
            echo "All scanned images are free of HIGH and CRITICAL vulnerabilities." >> $GITHUB_STEP_SUMMARY
          fi
