name: Tests

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  lint:
    name: Lint and Syntax Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install shellcheck
        run: sudo apt-get update && sudo apt-get install -y shellcheck

      - name: Bash syntax check
        run: |
          find . -name "*.sh" -type f -exec bash -n {} \;
          echo "All shell scripts pass syntax check"

      - name: Shellcheck
        run: |
          shellcheck -x -s bash -S warning *.sh lib/*.sh 2>&1 || true

      - name: YAML lint check
        run: |
          python3 -c "import yaml; yaml.safe_load(open('docker-compose.yml'))"
          echo "docker-compose.yml is valid YAML"

      - name: JSON lint check
        run: |
          python3 -c "import json; json.load(open('mcp/config.json'))"
          echo "mcp/config.json is valid JSON"

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Mock detection
        run: |
          ./audit-no-mock.sh

      - name: Check for hardcoded secrets
        run: |
          if grep -r "password\s*=\s*['\"]" --include="*.sh" --include="*.yaml" --include="*.yml" . 2>/dev/null | grep -v "replace-with" | grep -v "change-me" | grep -v "\${" ; then
            echo "Found potential hardcoded passwords"
            exit 1
          fi
          echo "No hardcoded secrets found"

  script-verification:
    name: Script Quality Verification
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Verify scripts
        run: |
          chmod +x verify-scripts.sh
          ./verify-scripts.sh || true

      - name: Check set -e usage
        run: |
          missing_set_e=0
          for script in *.sh; do
            if [ -f "$script" ] && head -20 "$script" | grep -q "^#!/bin/bash"; then
              if ! head -20 "$script" | grep -q "set -e"; then
                echo "Warning: $script may be missing 'set -e'"
                missing_set_e=$((missing_set_e + 1))
              fi
            fi
          done
          echo "Scripts checked. $missing_set_e may need 'set -e'"

  dependency-check:
    name: Dependency Version Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check for floating image tags
        run: |
          echo "Checking for floating Docker image tags..."
          if grep -E "image:.*:latest" docker-compose.yml; then
            echo "Warning: Found 'latest' tags in docker-compose.yml"
            echo "Consider pinning to specific versions for reproducibility"
          else
            echo "All images appear to be pinned to specific versions"
          fi

  baseline-tests:
    name: Baseline Integration Tests
    runs-on: ubuntu-latest
    needs: [lint, security-audit]
    if: github.event_name == 'workflow_dispatch' || github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Create test environment
        run: |
          cp .env.example .env
          sed -i 's/WEBUI_SECRET_KEY=.*/WEBUI_SECRET_KEY=test-secret-key-for-ci-minimum-32-chars/' .env
          sed -i 's/JUPYTER_TOKEN=.*/JUPYTER_TOKEN=test-jupyter-token/' .env
          sed -i 's/OPENAI_API_KEY=.*/OPENAI_API_KEY=test-openai-api-key/' .env
          sed -i 's/POSTGRES_PASSWORD=.*/POSTGRES_PASSWORD=test-postgres-password/' .env

      - name: Start services
        run: |
          docker compose up -d postgres || true
          sleep 10
          docker compose ps

      - name: Check service health
        run: |
          docker compose ps
          docker compose logs --tail=50 postgres || true

  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [lint, security-audit, script-verification, dependency-check]
    if: always()
    steps:
      - name: Check results
        run: |
          echo "=== Test Summary ==="
          echo "Lint: ${{ needs.lint.result }}"
          echo "Security Audit: ${{ needs.security-audit.result }}"
          echo "Script Verification: ${{ needs.script-verification.result }}"
          echo "Dependency Check: ${{ needs.dependency-check.result }}"

          if [ "${{ needs.lint.result }}" != "success" ] || \
             [ "${{ needs.security-audit.result }}" != "success" ] || \
             [ "${{ needs.script-verification.result }}" != "success" ]; then
            echo "Some checks failed"
            exit 1
          fi
          echo "All checks passed!"
